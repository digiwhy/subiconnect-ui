name: '[Auto] ⏩︎ Update Staging'

on:
  pull_request:
    types:
      - closed

jobs:
  update_staging:
    name: 🌀 Update Staging
    if:
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev' &&
      github.event.pull_request.head.ref == 'changeset-release/dev'
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🟢 Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ⤵️ Fetch all branches
        run: git fetch --all

      - name: 🕸️ Get the commit SHA of the merged pull request
        id: get_commit_sha
        run:
          echo "COMMIT_SHA=${{ github.event.pull_request.merge_commit_sha }}" >>
          $GITHUB_ENV

      - name: 🖋️ Update staging branch
        run: |
          git checkout staging
          git fetch origin ${{ env.COMMIT_SHA }}:refs/remotes/origin/dev-commit
          git reset --hard refs/remotes/origin/dev-commit
          git push origin staging --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create_pr_to_main:
    name: 🏃 Create PR to move release to main
    runs-on: ubuntu-latest
    needs: update_staging

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: main

      - name: 🔁 Reset branch
        run: |
          git fetch origin staging:staging
          git reset --hard staging

      - name: 📣 Create a new PR to move the release from staging to main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cpr-rc/main
          title: '[Auto] 🏃 Move the release from staging to main'
          body:
            'This PR was automatically created to update main from staging after
            merging the candidate release.'
          commit-message:
            'chore: update main from staging after candidate release'
