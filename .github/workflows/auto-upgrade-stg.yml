name: '⏩︎ [Auto] Update Staging'

on:
  pull_request:
    types:
      - closed

jobs:
  update_staging:
    name: 🌀 Update Staging
    if:
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    outputs:
      is_changeset_pr: ${{ steps.check_changeset_pr.outputs.is_changeset_pr }}

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🟢 Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: 📃 Check if it's a changeset PR
        id: check_changeset_pr
        run: |
          if git log -1 --pretty=%B | grep -F "[Automated] Version package - RC"; then
            echo "is_changeset_pr=true" > $GITHUB_OUTPUT
          else
            echo "is_changeset_pr=false" > $GITHUB_OUTPUT
          fi

      - name: ⤵️ Fetch all branches
        run: git fetch --all

      - name: 🕸️ Get the commit SHA of the merged pull request
        id: get_commit_sha
        run:
          echo "COMMIT_SHA=${{ github.event.pull_request.merge_commit_sha }}" >>
          $GITHUB_ENV

      - name: 🖋️ Update staging branch
        if: ${{ steps.check_changeset_pr.outputs.is_changeset_pr }} == 'true'
        run: |
          git checkout stg
          git fetch origin ${{ env.COMMIT_SHA }}:refs/remotes/origin/dev-commit
          git reset --hard refs/remotes/origin/dev-commit
          git push origin stg --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create_pr_to_main:
    name: 🏃 Create PR to move release to main
    runs-on: ubuntu-latest
    needs: update_staging
    if: needs.update_staging.outputs.is_changeset_pr == 'true'

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: main

      - name: 🔁 Reset branch
        run: |
          git fetch origin stg:stg
          git reset --hard stg

      - name: 📣 Create a new PR to move the release from staging to main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cpr-rc/main
          title: '[Auto] 🏃 Move the release from staging to main'
          body:
            'This PR was automatically created to update main from staging after
            merging the candidate release.'
          commit-message:
            'chore: update main from staging after candidate release'
